# ---------- Build stage ----------
    FROM golang:1.24-alpine AS builder

    # Install build dependencies
    RUN apk add --no-cache gcc musl-dev
    
    # Set working directory
    WORKDIR /app
    
    # Copy go mod and sum files
    COPY go.mod go.sum ./
    
    # Download dependencies
    RUN go mod download
    
    # Copy source code
    COPY . .
    
    # Build with debug flags
    RUN CGO_ENABLED=0 GOOS=linux go build -o filestore .
    
    # ---------- Final stage ----------
    FROM alpine:latest
    
    # Install runtime dependencies and add ptrace capability
    RUN apk add --no-cache ca-certificates tzdata libc6-compat
    
    # Set working directory
    WORKDIR /app
    
    # Copy the binary and Delve
    COPY --from=builder /app/filestore .
    
    # Copy migrations directory
    COPY --from=builder /app/migrations ./migrations
    
    # Create directory for .env file
    RUN mkdir -p /app/config
    
    # Expose app port
    EXPOSE 8080
    
    # Run with Delve
    CMD ["./filestore"]
    